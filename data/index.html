<!DOCTYPE html>
<html>
<head>
    <title>NetTuner - ESP32 Web Radio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>NetTuner - ESP32 Web Radio</h1>
        
        <div class="stream-info">
            <div id="status" class="status stopped">Stopped</div>
            <div id="currentStream">No stream selected</div>
        </div>
        
        <div class="controls">
            <select id="streamSelect">
                <option value="">Select a stream...</option>
            </select>
            
            <button class="play-btn" onclick="playStream()">Play</button>
            <button class="stop-btn" onclick="stopStream()">Stop</button>
            <button class="playlist-btn" onclick="window.location='/playlist.html'">Manage Playlist</button>
            
            <div class="volume-control">
                <label for="volume">Volume:</label>
                <input type="range" id="volume" min="0" max="100" value="50" oninput="setVolume(this.value)">
                <span id="volumeValue">50%</span>
            </div>
        </div>
    </div>

    <script>
        let streams = [];
        
        // Load playlist and status
        async function loadStreams() {
            try {
                console.log('Loading streams from /api/streams');
                const response = await fetch('/api/streams');
                console.log('Streams response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                streams = await response.json();
                console.log('Loaded streams:', streams);
                const select = document.getElementById('streamSelect');
                select.innerHTML = '<option value="">Select a stream...</option>';
                streams.forEach(stream => {
                    const option = document.createElement('option');
                    option.value = stream.url;
                    option.textContent = stream.name;
                    option.dataset.name = stream.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading streams:', error);
            }
        }
        
        // WebSocket connection
        let ws = null;
        
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // WebSocket server runs on port 81, not the same port as HTTP server
            const host = window.location.hostname;
            const wsUrl = `${protocol}//${host}:81/`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const status = JSON.parse(event.data);
                        console.log('Received status update:', status);
                        const statusElement = document.getElementById('status');
                        const currentElement = document.getElementById('currentStream');
                        
                        statusElement.textContent = status.playing ? 'Playing' : 'Stopped';
                        statusElement.className = 'status ' + (status.playing ? 'playing' : 'stopped');
                        currentElement.textContent = status.currentStreamName || 'No stream selected';
                        
                        document.getElementById('volume').value = status.volume;
                        document.getElementById('volumeValue').textContent = status.volume + '%';
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    // Try to reconnect after 3 seconds
                    setTimeout(connectWebSocket, 3000);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                // Fallback to polling if WebSocket fails
                setTimeout(connectWebSocket, 5000);
            }
        }
        
        async function playStream() {
            const select = document.getElementById('streamSelect');
            const option = select.options[select.selectedIndex];
            const url = select.value;
            const name = option ? option.dataset.name : '';
            
            console.log('Playing stream:', { url, name });
            
            if (!url) {
                alert('Please select a stream');
                return;
            }
            
            try {
                const response = await fetch('/api/play', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'url=' + encodeURIComponent(url) + '&name=' + encodeURIComponent(name)
                });
                console.log('Play response status:', response.status);
                if (!response.ok) {
                    throw new Error('Failed to play stream');
                }
            } catch (error) {
                console.error('Error playing stream:', error);
                alert('Error playing stream: ' + error.message);
            }
        }
        
        async function stopStream() {
            try {
                console.log('Stopping current stream');
                const response = await fetch('/api/stop', { method: 'POST' });
                console.log('Stop response status:', response.status);
            } catch (error) {
                console.error('Error stopping stream:', error);
            }
        }
        
        async function setVolume(volume) {
            try {
                console.log('Setting volume to:', volume);
                const response = await fetch('/api/volume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'volume=' + volume
                });
                console.log('Volume response status:', response.status);
                if (response.ok) {
                    document.getElementById('volumeValue').textContent = volume + '%';
                }
            } catch (error) {
                console.error('Error setting volume:', error);
            }
        }
        
        // Initialize
        window.onload = function() {
            loadStreams();
            connectWebSocket();
        };
    </script>
</body>
</html>
