<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NetTuner - WiFi Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h1>NetTuner - WiFi Configuration</h1>
        
        <div class="section">
            <h2>Available Networks</h2>
            <p class="help-text">Select a network from the list below to add it to your configuration. Networks marked with ★ are already configured.</p>
            <div id="networks">Scanning for networks...</div>
            <div class="form-group">
                <button class="btn-secondary" onclick="scanNetworks()">Refresh Networks</button>
            </div>
        </div>
        
        <div class="section">
            <h2>Configure WiFi Networks</h2>
            <p class="help-text">Add up to 5 WiFi networks. The device will try to connect to them in order of preference.</p>
            <div class="form-group">
                <small class="form-help">Tip: Add your most reliable networks first. The device will connect to the first available network in the list.</small>
            </div>
            <form id="wifiForm">
                <div id="networkFields">
                    <div class="network-entry">
                        <div class="form-group">
                            <label for="ssid0">Primary Network (SSID):</label>
                            <input type="text" id="ssid0" name="ssid0" placeholder="Enter SSID">
                        </div>
                        <div class="form-group">
                            <label for="password0">Password:</label>
                            <input type="password" id="password0" name="password0" placeholder="Enter Password">
                        </div>
                    </div>
                </div>
                <button type="button" id="addNetwork" class="btn-secondary" onclick="addNetworkField()">Add Network</button>
                <button type="submit" class="btn-primary">Save Configuration</button>
            </form>
        </div>
        
        <div class="section">
            <h2>Connection Status</h2>
            <p class="help-text">Current network connection information</p>
            <div id="connection-status">
                <p>Not connected</p>
            </div>
        </div>
        
        <div class="form-actions">
            <button class="btn-back" onclick="window.location.href='/'">Back to Main</button>
        </div>
    </div>

    <script src="/scripts.js"></script>
    <script>
        let networkCount = 1;
        let configuredNetworks = [];
        
        // Load existing WiFi configuration when page loads
        window.addEventListener('load', function() {
            loadConfiguredNetworks();
            scanNetworks();
            loadCurrentConfiguration();
        });
        
        function loadConfiguredNetworks() {
            // Load existing configuration to know which networks are already configured
            fetch('/api/wificonfig')
                .then(response => response.json())
                .then(data => {
                    // Handle consistent data structure for configured networks
                    if (Array.isArray(data)) {
                        // If array of strings (SSIDs only)
                        configuredNetworks = data;
                    } else if (data.configured && Array.isArray(data.configured)) {
                        // If object with configured array
                        configuredNetworks = data.configured;
                    } else if (data.networks && Array.isArray(data.networks)) {
                        // If object with networks array containing objects with ssid property
                        configuredNetworks = data.networks.map(network => 
                            typeof network === 'string' ? network : network.ssid
                        ).filter(ssid => ssid);
                    } else {
                        configuredNetworks = [];
                    }
                })
                .catch(error => {
                    console.error('Error loading configured networks:', error);
                    configuredNetworks = [];
                });
        }
        
        function loadCurrentConfiguration() {
            // Load current WiFi configuration to populate the form
            fetch('/api/wificonfig')
                .then(response => response.json())
                .then(data => {
                    // Handle consistent data structure for configuration loading
                    let configNetworks = [];
                    if (Array.isArray(data)) {
                        // If array of strings (SSIDs only)
                        configNetworks = data.map((ssid, index) => ({ ssid, password: '' }));
                    } else if (data.configured && Array.isArray(data.configured)) {
                        // If object with configured array of strings
                        configNetworks = data.configured.map((ssid, index) => ({ ssid, password: '' }));
                    } else if (data.networks && Array.isArray(data.networks)) {
                        // If object with networks array containing objects
                        configNetworks = data.networks.map(network => ({
                            ssid: typeof network === 'string' ? network : network.ssid || '',
                            password: network.password || ''
                        }));
                    }
                    
                    // Clear existing fields except the first one
                    const networkFields = document.getElementById('networkFields');
                    while (networkFields.children.length > 1) {
                        networkFields.removeChild(networkFields.lastChild);
                    }
                    
                    // Reset network count
                    networkCount = 1;
                    
                    // Populate with configured networks
                    if (configNetworks.length > 0) {
                        // Fill the first entry
                        document.getElementById('ssid0').value = configNetworks[0].ssid || '';
                        
                        // Add additional entries for each configured network
                        for (let i = 1; i < configNetworks.length && i < 5; i++) {
                            addNetworkField();
                            document.getElementById(`ssid${i}`).value = configNetworks[i].ssid || '';
                        }
                        networkCount = configNetworks.length;
                    }
                })
                .catch(error => {
                    console.error('Error loading current configuration:', error);
                });
        }
        
        function addNetworkField() {
            if (networkCount >= 5) {
                showToast('Maximum of 5 networks allowed', 'warning');
                return;
            }
            
            const networkFields = document.getElementById('networkFields');
            const newEntry = document.createElement('div');
            newEntry.className = 'network-entry';
            newEntry.innerHTML = `
                <div class="form-group">
                    <label for="ssid${networkCount}">SSID:</label>
                    <input type="text" id="ssid${networkCount}" name="ssid${networkCount}" placeholder="Enter SSID">
                </div>
                <div class="form-group">
                    <label for="password${networkCount}">Password:</label>
                    <input type="password" id="password${networkCount}" name="password${networkCount}" placeholder="Enter Password">
                </div>
                <button type="button" class="remove-btn" onclick="removeNetworkField(this)">Remove</button>
            `;
            networkFields.appendChild(newEntry);
            networkCount++;
        }
        
        function removeNetworkField(button) {
            if (document.querySelectorAll('.network-entry').length <= 1) {
                showToast('At least one network is required', 'warning');
                return;
            }
            
            button.parentElement.remove();
            networkCount = document.querySelectorAll('.network-entry').length;
        }
        
        // Override form submit to handle multiple networks
        document.getElementById('wifiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ssids = [];
            const passwords = [];
            
            // Collect all network entries
            const networkEntries = document.querySelectorAll('.network-entry');
            networkEntries.forEach((entry, index) => {
                const ssidInput = entry.querySelector(`#ssid${index}`);
                const passwordInput = entry.querySelector(`#password${index}`);
                
                if (ssidInput && ssidInput.value.trim()) {
                    ssids.push(ssidInput.value.trim());
                    passwords.push(passwordInput ? passwordInput.value : '');
                }
            });
            
            if (ssids.length === 0) {
                showToast('At least one SSID is required', 'error');
                return;
            }
            
            const data = {
                ssid: ssids,
                password: passwords
            };
            
            // Show saving state
            const saveButton = document.querySelector('.save-btn');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            fetch('/api/wifisave', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    showToast('WiFi configuration saved successfully', 'success');
                } else {
                    showToast('Error saving WiFi configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error saving WiFi configuration: ' + error.message, 'error');
            })
            .finally(() => {
                // Restore button state
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            });
        });
        
        
        function selectNetwork(ssid) {
            document.getElementById('ssid0').value = ssid;
        }
        
        // Override the scanNetworks function to highlight configured networks
        function scanNetworks() {
            const networksDiv = document.getElementById('networks');
            networksDiv.innerHTML = '<p class="scanning">Scanning for networks...</p>';
            
            fetch('/api/wifiscan')
                .then(response => response.json())
                .then(data => {
                    networksDiv.innerHTML = '';
                    
                    // Handle consistent data structure for network scanning
                    let scanNetworks = [];
                    if (Array.isArray(data)) {
                        // If array of objects with ssid and rssi properties
                        scanNetworks = data;
                    } else if (data.networks && Array.isArray(data.networks)) {
                        // If object with networks array
                        scanNetworks = data.networks;
                    } else {
                        // If object with ssid and rssi properties directly
                        scanNetworks = [data];
                    }
                    
                    if (scanNetworks.length === 0 || (scanNetworks.length === 1 && !scanNetworks[0].ssid)) {
                        networksDiv.innerHTML = '<p class="no-networks">No networks found. Move closer to your router or check if WiFi is enabled.</p>';
                        return;
                    }
                    
                    const networksList = document.createElement('div');
                    networksList.className = 'networks-list';
                    
                    scanNetworks.forEach(network => {
                        // Skip invalid networks
                        if (!network || !network.ssid) return;
                        
                        const networkDiv = document.createElement('div');
                        networkDiv.className = 'network-item';
                        
                        // Check if this network is already configured
                        const isConfigured = configuredNetworks.includes(network.ssid);
                        
                        // Signal strength indicator
                        let signalClass = 'signal-weak';
                        if (network.rssi > -60) signalClass = 'signal-strong';
                        else if (network.rssi > -70) signalClass = 'signal-medium';
                        
                        if (isConfigured) {
                            networkDiv.classList.add('configured-network');
                            networkDiv.innerHTML = `
                                <div class="network-info">
                                    <span class="network-name">${network.ssid} <span class="configured-marker">★ Configured</span></span>
                                    <span class="network-rssi ${signalClass}">${network.rssi} dBm</span>
                                </div>
                                <button class="btn-small" onclick="selectNetwork('${network.ssid}')">Reconfigure</button>
                            `;
                        } else {
                            networkDiv.innerHTML = `
                                <div class="network-info">
                                    <span class="network-name">${network.ssid}</span>
                                    <span class="network-rssi ${signalClass}">${network.rssi} dBm</span>
                                </div>
                                <button class="btn-small" onclick="selectNetwork('${network.ssid}')">Select</button>
                            `;
                        }
                        
                        networksList.appendChild(networkDiv);
                    });
                    
                    networksDiv.appendChild(networksList);
                })
                .catch(error => {
                    console.error('Error scanning networks:', error);
                    networksDiv.innerHTML = '<p class="error">Error scanning networks. Please try again.</p>';
                });
        }
    </script>
</body>
</html>
