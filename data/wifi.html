<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NetTuner - WiFi Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h1>NetTuner - WiFi Configuration</h1>
        <div id="networks">Scanning for networks...</div>
        
        <form id="wifiForm">
            <div id="networkFields">
                <div class="network-entry">
                    <div class="form-group">
                        <label for="ssid0">SSID:</label>
                        <input type="text" id="ssid0" name="ssid0" placeholder="Enter SSID">
                    </div>
                    <div class="form-group">
                        <label for="password0">Password:</label>
                        <input type="password" id="password0" name="password0" placeholder="Enter Password">
                    </div>
                </div>
            </div>
            <button type="button" id="addNetwork" onclick="addNetworkField()">Add Network</button>
            <button type="submit" class="save-btn">Save Configuration</button>
        </form>
        
        <div class="form-actions">
            <button onclick="scanNetworks()">Refresh Networks</button>
            <button onclick="window.location.href='/'">Back to Main</button>
        </div>
    </div>

    <script src="/scripts.js"></script>
    <script>
        let networkCount = 1;
        let configuredNetworks = [];
        
        // Load existing WiFi configuration when page loads
        window.addEventListener('load', function() {
            loadConfiguredNetworks();
            scanNetworks();
            loadCurrentConfiguration();
        });
        
        function loadConfiguredNetworks() {
            // Load existing configuration to know which networks are already configured
            fetch('/api/wifiscan')
                .then(response => response.json())
                .then(data => {
                    configuredNetworks = data.configured || [];
                })
                .catch(error => {
                    console.error('Error loading configured networks:', error);
                });
        }
        
        function loadCurrentConfiguration() {
            // Load current WiFi configuration to populate the form
            fetch('/api/wifiscan')
                .then(response => response.json())
                .then(data => {
                    const configured = data.configured || [];
                    const networks = data.networks || [];
                    
                    // Clear existing fields except the first one
                    const networkFields = document.getElementById('networkFields');
                    while (networkFields.children.length > 1) {
                        networkFields.removeChild(networkFields.lastChild);
                    }
                    
                    // Reset network count
                    networkCount = 1;
                    
                    // Populate with configured networks
                    if (configured.length > 0) {
                        // Fill the first entry
                        document.getElementById('ssid0').value = configured[0];
                        
                        // Add additional entries for each configured network
                        for (let i = 1; i < configured.length && i < 5; i++) {
                            addNetworkField();
                            document.getElementById(`ssid${i}`).value = configured[i];
                        }
                        networkCount = configured.length;
                    }
                })
                .catch(error => {
                    console.error('Error loading current configuration:', error);
                });
        }
        
        function addNetworkField() {
            if (networkCount >= 5) {
                alert('Maximum of 5 networks allowed');
                return;
            }
            
            const networkFields = document.getElementById('networkFields');
            const newEntry = document.createElement('div');
            newEntry.className = 'network-entry';
            newEntry.innerHTML = `
                <div class="form-group">
                    <label for="ssid${networkCount}">SSID:</label>
                    <input type="text" id="ssid${networkCount}" name="ssid${networkCount}" placeholder="Enter SSID">
                </div>
                <div class="form-group">
                    <label for="password${networkCount}">Password:</label>
                    <input type="password" id="password${networkCount}" name="password${networkCount}" placeholder="Enter Password">
                </div>
                <button type="button" class="remove-btn" onclick="removeNetworkField(this)">Remove</button>
            `;
            networkFields.appendChild(newEntry);
            networkCount++;
        }
        
        function removeNetworkField(button) {
            if (document.querySelectorAll('.network-entry').length <= 1) {
                alert('At least one network is required');
                return;
            }
            
            button.parentElement.remove();
            networkCount = document.querySelectorAll('.network-entry').length;
        }
        
        // Override form submit to handle multiple networks
        document.getElementById('wifiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ssids = [];
            const passwords = [];
            
            // Collect all network entries
            const networkEntries = document.querySelectorAll('.network-entry');
            networkEntries.forEach((entry, index) => {
                const ssidInput = entry.querySelector(`#ssid${index}`);
                const passwordInput = entry.querySelector(`#password${index}`);
                
                if (ssidInput && ssidInput.value.trim()) {
                    ssids.push(ssidInput.value.trim());
                    passwords.push(passwordInput ? passwordInput.value : '');
                }
            });
            
            if (ssids.length === 0) {
                alert('At least one SSID is required');
                return;
            }
            
            const data = {
                ssid: ssids,
                password: passwords
            };
            
            // Show saving state
            const saveButton = document.querySelector('.save-btn');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            fetch('/api/wifisave', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    alert('WiFi configuration saved successfully');
                } else {
                    alert('Error saving WiFi configuration');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving WiFi configuration');
            })
            .finally(() => {
                // Restore button state
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            });
        });
        
        
        function selectNetwork(ssid) {
            document.getElementById('ssid0').value = ssid;
        }
        
        // Override the scanNetworks function to highlight configured networks
        function scanNetworks() {
            const networksDiv = document.getElementById('networks');
            networksDiv.innerHTML = 'Scanning for networks...';
            
            fetch('/api/wifiscan')
                .then(response => response.json())
                .then(data => {
                    networksDiv.innerHTML = '<h3>Available Networks:</h3>';
                    
                    // Extract just the network list if the response includes configured networks
                    const networks = Array.isArray(data) ? data : data.networks || [];
                    
                    if (networks.length === 0) {
                        networksDiv.innerHTML += '<p>No networks found</p>';
                        return;
                    }
                    
                    networks.forEach(network => {
                        const networkDiv = document.createElement('div');
                        networkDiv.className = 'network-item';
                        
                        // Check if this network is already configured
                        const isConfigured = configuredNetworks.includes(network.ssid);
                        
                        if (isConfigured) {
                            networkDiv.classList.add('configured-network');
                            networkDiv.innerHTML = `
                                <span class="network-name">${network.ssid} â˜…</span>
                                <span class="network-rssi">(${network.rssi} dBm)</span>
                                <button onclick="selectNetwork('${network.ssid}')">Reconfigure</button>
                            `;
                        } else {
                            networkDiv.innerHTML = `
                                <span class="network-name">${network.ssid}</span>
                                <span class="network-rssi">(${network.rssi} dBm)</span>
                                <button onclick="selectNetwork('${network.ssid}')">Select</button>
                            `;
                        }
                        
                        networksDiv.appendChild(networkDiv);
                    });
                })
                .catch(error => {
                    console.error('Error scanning networks:', error);
                    networksDiv.innerHTML = 'Error scanning networks';
                });
        }
    </script>
</body>
</html>
